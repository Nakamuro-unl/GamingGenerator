<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIFå‡¦ç†ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            padding: 20px;
            background: #000;
            color: #0f0;
            line-height: 1.6;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .test-area {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #0f0;
            background: #001100;
        }
        canvas {
            border: 1px solid #0f0;
            margin: 10px;
        }
        img {
            border: 1px solid #0f0;
            margin: 10px;
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 10px;
            font-size: 12px;
            max-height: 300px;
            overflow-y: scroll;
            white-space: pre-wrap;
        }
        button {
            background: #003300;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 10px 20px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005500;
        }
        .success { color: #0f0; }
        .error { color: #f00; }
        .warning { color: #ff0; }
        .info { color: #0ff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ® GIFå‡¦ç†ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ</h1>
        
        <div class="test-area">
            <h2>1. ã‚²ãƒ¼ãƒŸãƒ³ã‚°åŠ¹æœãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
            <canvas id="gamingCanvas" width="256" height="256"></canvas>
            <img id="gifPreview" width="256" height="256" style="display: none;">
            <br>
            <button onclick="startGamingAnimation()">ã‚²ãƒ¼ãƒŸãƒ³ã‚°åŠ¹æœé–‹å§‹</button>
            <button onclick="stopGamingAnimation()">åœæ­¢</button>
        </div>
        
        <div class="test-area">
            <h2>2. GIFèª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ</h2>
            <input type="file" id="gifInput" accept="image/gif" onchange="handleGifUpload(event)">
            <div id="gifInfo" class="log"></div>
        </div>
        
        <div class="test-area">
            <h2>3. APIæ¥ç¶šãƒ†ã‚¹ãƒˆ</h2>
            <button onclick="testApiConnection()">APIæ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
            <div id="apiLog" class="log"></div>
        </div>
        
        <div class="test-area">
            <h2>4. çµ±åˆãƒ†ã‚¹ãƒˆ</h2>
            <button onclick="runFullTest()">å®Œå…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
            <div id="fullTestLog" class="log"></div>
        </div>
        
        <div class="test-area">
            <h2>5. ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°</h2>
            <div id="systemLog" class="log"></div>
        </div>
    </div>

    <script>
        let gamingAnimationId = null;
        let systemLogElement = document.getElementById('systemLog');
        
        // ãƒ­ã‚°å‡ºåŠ›ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼
        function log(message, type = 'info', containerId = 'systemLog') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            const logEntry = `[${timestamp}] ${message}\n`;
            
            container.innerHTML += `<span class="${className}">${logEntry}</span>`;
            container.scrollTop = container.scrollHeight;
            
            // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚å‡ºåŠ›
            console.log(logEntry.trim());
        }
        
        // 1. ã‚²ãƒ¼ãƒŸãƒ³ã‚°åŠ¹æœã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        function startGamingAnimation() {
            const canvas = document.getElementById('gamingCanvas');
            const ctx = canvas.getContext('2d');
            let progress = 0;
            
            log('ã‚²ãƒ¼ãƒŸãƒ³ã‚°åŠ¹æœã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹', 'success');
            
            function animate() {
                // èƒŒæ™¯ã‚’ã‚¯ãƒªã‚¢
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // è™¹è‰²ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ
                for (let x = 0; x < canvas.width; x++) {
                    const hue = (x / canvas.width * 360 + progress * 36) % 360;
                    
                    // HSVã‹ã‚‰RGBã«å¤‰æ›
                    const h = hue / 60.0;
                    const c = 255;
                    const x_val = c * (1 - Math.abs((h % 2) - 1));
                    
                    let r, g, b;
                    if (0 <= h && h < 1) {
                        r = c; g = x_val; b = 0;
                    } else if (1 <= h && h < 2) {
                        r = x_val; g = c; b = 0;
                    } else if (2 <= h && h < 3) {
                        r = 0; g = c; b = x_val;
                    } else if (3 <= h && h < 4) {
                        r = 0; g = x_val; b = c;
                    } else if (4 <= h && h < 5) {
                        r = x_val; g = 0; b = c;
                    } else {
                        r = c; g = 0; b = x_val;
                    }
                    
                    ctx.strokeStyle = `rgba(${Math.floor(r)}, ${Math.floor(g)}, ${Math.floor(b)}, 0.7)`;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, canvas.height);
                    ctx.stroke();
                }
                
                progress += 0.1;
                gamingAnimationId = requestAnimationFrame(animate);
            }
            
            gamingAnimationId = requestAnimationFrame(animate);
        }
        
        function stopGamingAnimation() {
            if (gamingAnimationId) {
                cancelAnimationFrame(gamingAnimationId);
                gamingAnimationId = null;
                log('ã‚²ãƒ¼ãƒŸãƒ³ã‚°åŠ¹æœã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢', 'warning');
            }
        }
        
        // 2. GIFèª­ã¿è¾¼ã¿å‡¦ç†
        async function handleGifUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            log(`GIFãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ: ${file.name} (${file.size} bytes)`, 'info', 'gifInfo');
            
            try {
                // ãƒ•ã‚¡ã‚¤ãƒ«åŸºæœ¬æƒ…å ±
                const isGif = file.type === 'image/gif' || file.name.toLowerCase().endsWith('.gif');
                if (!isGif) {
                    log('GIFãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“', 'error', 'gifInfo');
                    return;
                }
                
                // ç”»åƒã¨ã—ã¦èª­ã¿è¾¼ã¿
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const img = new Image();
                    img.onload = () => {
                        log(`ç”»åƒã‚µã‚¤ã‚º: ${img.width}x${img.height}`, 'success', 'gifInfo');
                        
                        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                        const preview = document.getElementById('gifPreview');
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
                
                // ãƒ•ãƒ¬ãƒ¼ãƒ æ•°æ¤œå‡º
                const frameCount = await detectGifFrameCount(file);
                log(`æ¨å®šãƒ•ãƒ¬ãƒ¼ãƒ æ•°: ${frameCount}`, 'info', 'gifInfo');
                
            } catch (error) {
                log(`GIFå‡¦ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error', 'gifInfo');
            }
        }
        
        // GIFãƒ•ãƒ¬ãƒ¼ãƒ æ•°æ¤œå‡º
        async function detectGifFrameCount(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const arrayBuffer = e.target.result;
                        const uint8View = new Uint8Array(arrayBuffer);
                        
                        // GIFãƒ˜ãƒƒãƒ€ãƒ¼ãƒã‚§ãƒƒã‚¯
                        const header = String.fromCharCode(...uint8View.slice(0, 6));
                        if (!header.startsWith('GIF')) {
                            reject(new Error('æœ‰åŠ¹ãªGIFãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“'));
                            return;
                        }
                        
                        // ãƒ•ãƒ¬ãƒ¼ãƒ æ•°æ¨å®š
                        let frameCount = 0;
                        for (let i = 0; i < uint8View.length - 3; i++) {
                            if (uint8View[i] === 0x21 && uint8View[i + 1] === 0xF9) {
                                frameCount++;
                            }
                        }
                        
                        resolve(Math.max(1, Math.min(frameCount, 100)));
                        
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }
        
        // 3. APIæ¥ç¶šãƒ†ã‚¹ãƒˆ
        async function testApiConnection() {
            log('APIæ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹', 'info', 'apiLog');
            
            const apiUrls = [
                window.location.origin,
                'https://gaming-generator-qjlika608-nakamuros-projects-f99bfc51.vercel.app',
                'https://gaming-generator.vercel.app'
            ];
            
            for (const apiUrl of apiUrls) {
                try {
                    log(`ãƒ†ã‚¹ãƒˆä¸­: ${apiUrl}/api/test`, 'info', 'apiLog');
                    
                    const response = await fetch(`${apiUrl}/api/test`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ test: true })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        log(`âœ… ${apiUrl} - æ¥ç¶šæˆåŠŸ: ${data.message}`, 'success', 'apiLog');
                        return apiUrl;
                    } else {
                        log(`âŒ ${apiUrl} - HTTP ${response.status}`, 'error', 'apiLog');
                    }
                } catch (error) {
                    log(`âŒ ${apiUrl} - ${error.message}`, 'error', 'apiLog');
                }
            }
            
            log('å…¨ã¦ã®APIæ¥ç¶šã«å¤±æ•—', 'error', 'apiLog');
        }
        
        // 4. å®Œå…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        async function runFullTest() {
            log('===== å®Œå…¨ãƒ†ã‚¹ãƒˆé–‹å§‹ =====', 'info', 'fullTestLog');
            
            try {
                // ã‚²ãƒ¼ãƒŸãƒ³ã‚°åŠ¹æœãƒ†ã‚¹ãƒˆ
                log('1. ã‚²ãƒ¼ãƒŸãƒ³ã‚°åŠ¹æœãƒ†ã‚¹ãƒˆ', 'info', 'fullTestLog');
                startGamingAnimation();
                await new Promise(resolve => setTimeout(resolve, 2000));
                stopGamingAnimation();
                log('âœ… ã‚²ãƒ¼ãƒŸãƒ³ã‚°åŠ¹æœãƒ†ã‚¹ãƒˆå®Œäº†', 'success', 'fullTestLog');
                
                // APIæ¥ç¶šãƒ†ã‚¹ãƒˆ
                log('2. APIæ¥ç¶šãƒ†ã‚¹ãƒˆ', 'info', 'fullTestLog');
                try {
                    const workingApi = await testApiConnection();
                    log(`âœ… åˆ©ç”¨å¯èƒ½API: ${workingApi}`, 'success', 'fullTestLog');
                } catch (error) {
                    log(`âš ï¸ APIæ¥ç¶šå¤±æ•—: ${error.message}`, 'warning', 'fullTestLog');
                }
                
                // GIFãƒ†ã‚¹ãƒˆï¼ˆtest_animated.gifãŒã‚ã‚‹å ´åˆï¼‰
                log('3. GIFãƒ•ã‚¡ã‚¤ãƒ«ãƒ†ã‚¹ãƒˆ', 'info', 'fullTestLog');
                try {
                    const response = await fetch('/test_animated.gif');
                    if (response.ok) {
                        const blob = await response.blob();
                        const frameCount = await detectGifFrameCount(blob);
                        log(`âœ… ãƒ†ã‚¹ãƒˆGIF: ${blob.size} bytes, ${frameCount} ãƒ•ãƒ¬ãƒ¼ãƒ `, 'success', 'fullTestLog');
                    } else {
                        log('âš ï¸ ãƒ†ã‚¹ãƒˆGIFãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'warning', 'fullTestLog');
                    }
                } catch (error) {
                    log(`âš ï¸ GIFãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'warning', 'fullTestLog');
                }
                
                log('===== å…¨ãƒ†ã‚¹ãƒˆå®Œäº† =====', 'success', 'fullTestLog');
                
            } catch (error) {
                log(`âŒ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error', 'fullTestLog');
            }
        }
        
        // åˆæœŸåŒ–
        log('GIFå‡¦ç†ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆæº–å‚™å®Œäº†', 'success');
        log('å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒœã‚¿ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„', 'info');
        
        // è‡ªå‹•ã§ã‚²ãƒ¼ãƒŸãƒ³ã‚°åŠ¹æœã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        setTimeout(startGamingAnimation, 1000);
    </script>
</body>
</html>